webpackJsonp([75],{1481:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a,s,r=n(3),i=(n.n(r),n(667)),c=n(45),o=n(18),l=n(575),u=n(89),h=n(17),f=n(583),m=n(92),d=n(14),p=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function a(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(a.prototype=n.prototype,new a)}}(),g=this&&this.__awaiter||function(t,e,n,a){return new(n||(n=Promise))(function(s,r){function i(t){try{o(a.next(t))}catch(t){r(t)}}function c(t){try{o(a.throw(t))}catch(t){r(t)}}function o(t){t.done?s(t.value):function(t){return t instanceof n?t:new n(function(e){e(t)})}(t.value).then(i,c)}o((a=a.apply(t,e||[])).next())})},v=this&&this.__generator||function(t,e){var n,a,s,r,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"===typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(r){return function(c){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,a&&(s=2&r[0]?a.return:r[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,r[1])).done)return s;switch(a=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,a=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(s=(s=i.trys).length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){i=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){i.label=r[1];break}if(6===r[0]&&i.label<s[1]){i.label=s[1],s=r;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(r);break}s[2]&&i.ops.pop(),i.trys.pop();continue}r=e.call(t,i)}catch(t){r=[6,t],a=0}finally{n=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,c])}}},y=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var a=Array(t),s=0;for(e=0;e<n;e++)for(var r=arguments[e],i=0,c=r.length;i<c;i++,s++)a[s]=r[i];return a};function b(){var t=document.getElementById("chatMessagesContainer");t&&(t.scrollTop=t?t.scrollHeight:0)}var N=function(t){function e(e){var n=t.call(this,e)||this;return n.state={chatMessages:[],chatText:"",participants:[],tag:"",issue:""},a=n,n.s3=new c.b,n.fetchContactInfo=n.fetchContactInfo.bind(n),n}return p(e,t),e.prototype.componentDidMount=function(){return g(this,void 0,void 0,function(){var t,e,n,r,i;return v(this,function(c){switch(c.label){case 0:return t=this.props,e=t.buildingName,n=t.contactIDs,r=t.s,e&&n?[4,this.fetchContactInfo()]:[3,3];case 1:return c.sent(),[4,this.getAllMessages()];case 2:c.sent(),(i=document.querySelector("#messageBody")).scrollTop=i.scrollHeight-i.clientHeight,s=window.innerHeight-270,c.label=3;case 3:return r&&r._socket&&r._socket.on&&r._socket.on("new message",function(t){var e=a.state.chatMessages;(0==e.length||e.length>0&&JSON.stringify(e[e.length-1])!=JSON.stringify(t))&&a.state.tag==t.tag&&(e.push(t),a.setState({chatMessages:e},function(){a.saveAllMessages(),b()}))}),[2]}})})},e.prototype.fetchContactInfo=function(){return g(this,void 0,void 0,function(){var t,e,n,a,s,r,c,o=this;return v(this,function(u){switch(u.label){case 0:return t=this.props,e=t.buildingName,n=t.contactIDs,a=t.entityTitle,e&&n?(s=[],r="",c="",a&&"Contact"!=a?[4,Object(i.k)("",a).then(function(t){if(t.length>0){var e=t[0];s=Object(h.g)(e.chatName).split("-_-"),c=Object(h.g)(e.description)}})]:[3,2]):[3,5];case 1:return u.sent(),[3,3];case 2:s=n,u.label=3;case 3:return s=y(s.sort(function(t,e){if(t&&e){var n=0;return t<e&&(n=-1),t>e&&(n=1),1*n}})),[4,Object(l.n)("",s).then(function(t){t.length>0&&(r+="Chat-_-",r+=t.map(function(t){return Object(h.g)(t.contact)}).join("-_-"),o.setState({participants:t,tag:r,issue:c},function(){return g(o,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:return[4,Object(i.w)(r)];case 1:return t.sent(),[2]}})})}))})];case 4:u.sent(),u.label=5;case 5:return[2]}})})},e.prototype.getAllMessages=function(){return g(this,void 0,void 0,function(){var t,e,n;return v(this,function(s){return t=this.state,e=t.participants,n=t.tag,e&&e.length&&this.s3.GetObject(c.a.CHAT(),n+".json",function(t,e){if(t)console.log("Get Object Error Returned",t);else{var n=Object(o.c)(e.Body);if(n){var s=JSON.parse(n);s.length>a.state.chatMessages.length&&a.setState({chatMessages:s}),b()}}}),[2]})})},e.prototype.saveAllMessages=function(){return g(this,void 0,void 0,function(){var t,e,n;return v(this,function(a){return t=this.state,e=t.participants,n=t.tag,e&&e.length&&this.s3.PutObject(c.a.CHAT(),n+".json",JSON.stringify(this.state.chatMessages)),[2]})})},e.prototype.handleChatInput=function(t){this.setState({chatText:t})},e.prototype.handleChatInputKeys=function(t){(13===t.which||"Enter"===t.key)&&t.target.value&&t.target.value.trim()&&(this.setState({chatText:t.target.value.trim()}),this.sendMessage())},e.prototype.sendMessage=function(){return g(this,void 0,void 0,function(){var t,e,n,s,r,c,o,l;return v(this,function(u){return t=this.props.entityTitle,this.state.chatText&&this.state.chatText.trim()&&(e=JSON.parse(d.a.getItem("user")),n=this.state,s=n.participants,r=n.tag,c=this.state.chatText,o={from:e.contact,fromName:e.name,messageText:c,tag:r,timestamp:(new Date).toString()},Object(m.d)(o),(l=this.state.chatMessages).push(o),this.setState({chatMessages:l,chatText:""},function(){Object(i.r)(t,"Chat-_-"+s.map(function(t){return""+t.contact.value}).sort(function(t,e){if(t&&e){var n=0;return t<e&&(n=-1),t>e&&(n=1),1*n}}).join("-_-")),a.saveAllMessages()}),b()),[2]})})},e.prototype.render=function(){var t=this,e=this.props.entityTitle,n=this.state,a=n.chatMessages,i=n.chatText,c=n.participants,o=n.issue,l=JSON.parse(d.a.getItem("user")),m=Object(f.b)(l,"task-ticket","write"),p=-1!=c.findIndex(function(t){return Object(h.g)(t.contact)==l.contact});return r.createElement(u.a.Consumer,null,function(n){return r.createElement("div",{className:"container-fluid "},r.createElement("div",{className:"content"},r.createElement("div",{className:"chatHead"},r.createElement("div",{className:"col-md-12"},r.createElement("div",{className:"form-group"},r.createElement("label",{className:"heading"},e," -- ",c.map(function(t){return Object(h.g)(t.name)}).join(" -- "),""!=o?"--"+o:"")))),r.createElement("div",{id:"chatMessagesContainer",className:" padding-10 chatBody"},r.createElement("div",{className:"col-md-12"},r.createElement("div",{className:"card padding-10 scroll",id:"messageBody",style:{height:s,overflowX:"hidden",margin:"0px"}},r.createElement("div",{className:"container-fluid"},r.createElement("div",{className:"row"},r.createElement("div",{className:"card col-md-12 col-xs-12 padding-10",style:{margin:"0px"}},0==a.length&&r.createElement("div",null," No messages found in this conversation. "),a.map(function(t,e){if(t&&t.from){var n=c.find(function(e){return e.contact.value==t.from});if(n&&n.name)return r.createElement("div",{key:e,className:"padding-10 chat-message "+(t.from==l.contact?"inbound-message":"outbound-message")},r.createElement("div",{className:"message-text padding-5",style:{overflowWrap:"break-word"}},t.messageText),r.createElement("div",{className:"sender-name"},r.createElement("label",null,r.createElement("b",null,n.name.value))),r.createElement("div",{className:"timestamp"},r.createElement("b",null,t.timestamp.ToEasternDateTime())))}}))))),p&&m&&r.createElement("footer",{className:"col-md-12 no-padding"},r.createElement("div",{className:"card",style:{margin:"0px"}},r.createElement("div",{className:"container-fluid"},r.createElement("div",{className:"row"},r.createElement("div",{className:"col-md-12 no-padding"},r.createElement("div",{className:"",style:{display:"inline-flex",padding:"0px",width:"100%"}},r.createElement("input",{type:"text",className:"form-control",placeholder:"Type your message here...",name:"chatBox",value:i,style:{height:"97px"},onChange:function(e){return t.handleChatInput(e.target.value)},onKeyPress:function(e){return t.handleChatInputKeys(e)}}),r.createElement("button",{type:"button",className:"btn pull-right btn-primary btn-fill chatButton",onClick:function(){t.sendMessage()}},r.createElement("i",{className:"fa fa-comment"}),"\xa0 Send ")))))))))))})},e}(r.Component);e.default=N}});