webpackJsonp([75],{1789:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,s=n(3),i=(n.n(s),n(101)),o=n(49),c=n(29),r=n(609),l=n(102),d=n(18),u=n(10),m=n(104),h=n(600),p=n(696),g=n(19),f=n(30),b=n(774),v=n(909),y=n(1096),N=n(99),O=n(1237),T=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function a(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(a.prototype=n.prototype,new a)}}(),E=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))(function(s,i){function o(e){try{r(a.next(e))}catch(e){i(e)}}function c(e){try{r(a.throw(e))}catch(e){i(e)}}function r(e){e.done?s(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(o,c)}r((a=a.apply(e,t||[])).next())})},w=this&&this.__generator||function(e,t){var n,a,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"===typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,a&&(s=2&i[0]?a.return:i[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,i[1])).done)return s;switch(a=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,a=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],a=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},j=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var a=Array(e),s=0;for(t=0;t<n;t++)for(var i=arguments[t],o=0,c=i.length;o<c;o++,s++)a[s]=i[o];return a};function x(){var e=document.getElementById("messageBody");e.scrollTop=e.scrollHeight}var C=function(e){function t(t){var n=e.call(this,t)||this;return n.state={chatMessages:[],chatText:"",participants:[],tag:"",issue:"",chat:Object(),chatPage:0,showUploader:!1,files:[],documentList:[],documentObj:{docOntology:"",entityOntology:n.props.entityTitle?[{label:n.props.entityTitle,value:n.props.entityTitle}]:[],entityType:"Chat",documentType:"Media",documentSubtype:"",rdfsLabel:"",s3FileName:"",entryTimeStamp:"",enteredBy:"",enteredByName:"",linkToDocument:"",building:n.props.buildingName,buildingName:""},isOpen:!1,documentName:"",showVideoChat:!1,showOutGoing:!1,showNotAvailable:!1,stream:void 0,incomingStream:void 0,showIncoming:!1,hideIncomingCall:!1,callAccepted:!1},a=n,n.s3=new o.b,n.fetchContactInfo=n.fetchContactInfo.bind(n),n.handlefileAttached=n.handlefileAttached.bind(n),n.addNewMessage=n.addNewMessage.bind(n),n}return T(t,e),t.prototype.componentDidMount=function(){return E(this,void 0,void 0,function(){var e,t,n,a,s,o,c,l,u,m,h,p,g,f,b,v=this;return w(this,function(y){switch(y.label){case 0:return e=this.state,t=e.participants,n=e.chat,a=e.chatMessages,s=e.chatPage,Object(N.a)(!0),[4,Object(r.n)()];case 1:return o=y.sent(),c=""!==this.props.assignedBy&&o.find(function(e){return Object(d.g)(e.contact)==v.props.assignedBy}),(l=[])[0]=Object(),c&&(l[0].assignedTo=c.contact,l[0].assignedToName=c.name),c?(m=l,[3,4]):[3,2];case 2:return[4,Object(i.r)(this.props.buildingName,this.props.parentTask)];case 3:m=y.sent(),y.label=4;case 4:return u=m,[4,Object(i.r)(this.props.buildingName,this.props.entityTitle)];case 5:return h=y.sent(),[4,Object(i.q)(this.props.entityTitle)];case 6:return p=y.sent(),g=Object(),f=Object(),p?(g.assignedTo=p.participants[0].assignedTo,g.assignedToName=p.participants[0].assignedToName,t.push(g),f.assignedTo=p.participants[1].assignedTo,f.assignedToName=p.participants[1].assignedToName,t.push(f),n=p,[4,Object(i.s)(n._id,s)]):[3,8];case 7:return b=(b=y.sent()).reverse(),a=b,[3,9];case 8:g.assignedTo=Object(d.g)(u[0].assignedTo),g.assignedToName=Object(d.g)(u[0].assignedToName),t.push(g),f.assignedTo=Object(d.g)(h[0].assignedTo),f.assignedToName=Object(d.g)(h[0].assignedToName),t.push(f),y.label=9;case 9:return this.VideoChat(),this.setState({chat:n,chatMessages:a,participants:t}),x(),Object(N.a)(!1),[2]}})})},t.prototype.VideoChat=function(e,t){return E(this,void 0,void 0,function(){var e,t,n,a,s=this;return w(this,function(i){return e=m.t,t=setInterval(function(){m.a&&(s.setState({showIncoming:!0}),clearInterval(t))},250),n=setInterval(function(){m.y&&(console.log("acceptedVideo","-----------"),s.setState({hideIncomingCall:!0,callAccepted:!0,incomingStream:m.y}),clearInterval(n))},250),a=setInterval(function(){if(m.i){if(s.state.stream)s.state.stream.getTracks().forEach(function(e){e.stop()});s.setState({showOutGoing:!1,showIncoming:!1,hideIncomingCall:!1,stream:null}),Object(m.j)(),Object(m.w)(),window.location.reload(),clearInterval(a)}},250),this.setState({mySocketId:e}),[2]})})},t.prototype.initiatingCall=function(){return E(this,void 0,void 0,function(){var e,t,n,a=this;return w(this,function(s){switch(s.label){case 0:return e=JSON.parse(u.a.getItem("user")),t=this.state.participants.find(function(t){return t.assignedTo!==e.contact}),[4,Object(m.p)(t.assignedTo,e.contact)];case 1:return s.sent(),n=m.t,navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(t){a.setState({mySocketId:n,stream:t}),m.l?Object(m.f)(m.l,a.state.stream,a.state.mySocketId,e.name,e.contact,a.props.buildingName):a.setState({showNotAvailable:!0,showOutGoing:!1},function(){a.state.stream&&a.state.stream.getTracks().forEach(function(e){e.stop()})})}),[2]}})})},t.prototype.addNewMessage=function(){return E(this,void 0,void 0,function(){var e,t,n,a,s,o,c,r,l=this;return w(this,function(d){switch(d.label){case 0:return m.v!==this.props.entityTitle?(Object(m.x)(),[2]):(e=this.state,t=e.chatMessages,n=e.participants,a=m.n,(s=j(t)).push(a),n=[],this.state.chat._id?[3,2]:[4,Object(i.a)(m.n.chatId)]);case 1:return o=d.sent(),c=Object(),r=Object(),c.assignedTo=o.participants[0].assignedTo,c.assignedToName=o.participants[0].assignedToName,n.push(c),r.assignedTo=o.participants[1].assignedTo,r.assignedToName=o.participants[1].assignedToName,n.push(r),this.setState({chatMessages:s,chat:o,participants:n},function(){Object(m.x)(),x(),Object(i.b)(l.state.chatMessages[0].chatId)}),[3,3];case 2:this.setState({chatMessages:s},function(){Object(m.x)(),x(),Object(i.b)(l.state.chatMessages[0].chatId)}),d.label=3;case 3:return[2]}})})},t.prototype.handleTitleChange=function(e){var t=this.state.documentObj;t.rdfsLabel=e,this.setState({documentObj:t},function(){t.rdfsLabel?document.getElementById("fileTitle").style.boxShadow="0px 0px 15px gainsboro":document.getElementById("fileTitle").style.boxShadow="0px 0px 15px red"})},t.prototype.saveDoc=function(){return E(this,void 0,void 0,function(){return w(this,function(e){switch(e.label){case 0:return[4,Object(b.f)(this.state.documentObj).then(function(){})];case 1:return e.sent(),[2]}})})},t.prototype._fetchDocs=function(){var e=this,t=this.props,n=t.buildingName,a=t.entityTitle;Object(b.d)(n,["Chat"],[a]).then(function(t){e.setState({documentList:t})})},t.prototype.handlefileAttached=function(e){var t=this,n=this.state.documentObj;if(e.length>0){var a=this.state.files,s=JSON.parse(u.a.getItem("user"));a||(a=[]);var i=e[0].name.split(".").pop(),o=(new Date).YYMMDDHHMMSS2()+"-"+n.rdfsLabel+"."+i.toLowerCase();o=o.replace(new RegExp(" ","g"),"-"),n.s3FileName=o,n.enteredBy=s.contact,Object(g.g)(e),this.setState({files:e,documentObj:n},function(){return E(t,void 0,void 0,function(){return w(this,function(e){return[2]})})})}},t.prototype.saveImage=function(){return E(this,void 0,void 0,function(){var e,t,n,a,s,i=this;return w(this,function(c){switch(c.label){case 0:return(e=this.state.documentObj).entityOntology&&e.entityOntology.length?(t=new o.b,(n=Object(g.d)())&&n.length?(a=n[0],s=a,[4,t.UploadFile(o.a.DOCUMENT(),e.s3FileName,s,function(t){i.sendMessage(e.s3FileName,e.rdfsLabel),i.saveDoc().then(function(){i._fetchDocs(),i.setState({files:[],documentObj:Object()},function(){return E(i,void 0,void 0,function(){return w(this,function(e){return[2]})})})}),Object(f.b)("Attachment Uploaded Successfully")})]):[3,2]):[3,3];case 1:c.sent(),c.label=2;case 2:return[3,4];case 3:Object(f.a)("To Upload Attachments, You need to save Form first "),c.label=4;case 4:return[2]}})})},t.prototype.componentWillUnmount=function(){clearInterval(void 0)},t.prototype.fetchContactInfo=function(){return E(this,void 0,void 0,function(){var e,t,n,a,s,o,c,l=this;return w(this,function(u){switch(u.label){case 0:return e=this.props,t=e.buildingName,n=e.contactIDs,a=e.entityTitle,t&&n?(s=[],o="",c="",a&&"Contact"!=a?[4,Object(i.o)("",a).then(function(e){if(e.length>0){var t=e[0];s=Object(d.g)(t.chatName).split("-_-"),c=Object(d.g)(t.description)}})]:[3,2]):[3,5];case 1:return u.sent(),[3,3];case 2:s=n,u.label=3;case 3:return s=j(s.sort(function(e,t){if(e&&t){var n=0;return e<t&&(n=-1),e>t&&(n=1),1*n}})),[4,Object(r.n)("",s).then(function(e){e.length>0&&(o+="Chat-_-",o+=e.map(function(e){return Object(d.g)(e.contact)}).join("-_-"),l.setState({tag:o,issue:c},function(){return E(l,void 0,void 0,function(){return w(this,function(e){switch(e.label){case 0:return[4,Object(i.E)(o)];case 1:return e.sent(),[2]}})})}))})];case 4:u.sent(),u.label=5;case 5:return[2]}})})},t.prototype.getAllMessages=function(){return E(this,void 0,void 0,function(){var e,t,n;return w(this,function(s){return e=this.state,t=e.participants,n=e.tag,t&&t.length&&this.s3.GetObject(o.a.CHAT(),n+".json",function(e,t){if(e)console.log("Get Object Error Returned",e);else{var n=Object(c.c)(t.Body);if(n){var s=JSON.parse(n);s.length>a.state.chatMessages.length&&a.setState({chatMessages:s}),x()}}}),[2]})})},t.prototype.saveAllMessages=function(){return E(this,void 0,void 0,function(){var e,t,n;return w(this,function(a){return e=this.state,t=e.participants,n=e.tag,t&&t.length&&this.s3.PutObject(o.a.CHAT(),n+".json",JSON.stringify(this.state.chatMessages)),[2]})})},t.prototype.handleChatInput=function(e){this.setState({chatText:e})},t.prototype.handleChatInputKeys=function(e){console.log("__________________",e.key),(13===e.which||"Enter"===e.key)&&e.target.value&&e.target.value.trim()&&(this.setState({chatText:e.target.value.trim()}),this.sendMessage())},t.prototype.sendMessage=function(e,t){return E(this,void 0,void 0,function(){var n,a,s,o,c,r,l,d;return w(this,function(h){switch(h.label){case 0:return n=this.state,a=n.chatText,s=n.chat,o=n.chatMessages,c=JSON.parse(u.a.getItem("user")),r=[],s._id?[3,4]:[4,Object(i.i)(this.state.participants,this.props.entityTitle).then(function(e){return e})];case 1:return(l=h.sent())._id?[4,Object(i.d)(l._id,c.contact,c.name,t||a,e||"")]:[3,3];case 2:(d=h.sent())._id&&(r=this.state.participants.filter(function(e){return e.assignedTo!==c.contact}).map(function(e){return e.assignedTo}),o.push(d),this.setState({chatText:"",chatMessages:o,chat:l})),Object(m.q)(d,r,this.props.entityTitle),h.label=3;case 3:return[3,6];case 4:return[4,Object(i.d)(s._id,c.contact,c.name,t||a,e||"")];case 5:(d=h.sent())._id&&(r=this.state.participants.filter(function(e){return e.assignedTo!==c.contact}).map(function(e){return e.assignedTo}),o.push(d),this.setState({chatText:"",chatMessages:o})),Object(m.q)(d,r,this.props.entityTitle),h.label=6;case 6:return x(),[2]}})})},t.prototype.getMoreMessages=function(){return E(this,void 0,void 0,function(){var e,t,n,a,s,o;return w(this,function(c){switch(c.label){case 0:return e=this.state,t=e.chatPage,n=e.chat,a=e.chatMessages,t+=1,[4,Object(i.s)(n._id,t)];case 1:return s=c.sent(),o=[],s&&s.reverse(),s.map(function(e){o.push(e)}),a.length>8&&a.splice(0,a.length-8),a.map(function(e){o.push(e)}),this.setState({chatPage:t,chatMessages:o}),[2]}})})},t.prototype.render=function(){var e=this,t=(this.props,this.state),n=t.chatMessages,a=t.chatText,i=t.documentObj,c=t.files,r=t.isOpen,d=t.showOutGoing,g=t.showNotAvailable,f=t.showIncoming,b=t.hideIncomingCall,N=JSON.parse(u.a.getItem("user")),T=new o.b,E=this.state.participants.find(function(e){return e.assignedTo!==N.contact});return s.createElement(l.a.Consumer,null,function(t){return s.createElement("div",null,g&&s.createElement(y.a,{buildingName:e.props.buildingName,endButtonText:"Close",notAvailable:!0,caller:E,onEndCallFunctionality:function(){e.setState({showNotAvailable:!1})}}),d&&s.createElement(y.a,{buildingName:e.props.buildingName,hideIncomingCall:b,endButtonText:"End Call",caller:E,showOutgoing:!0,onAcceptingReceivingCall:function(){},onShareScreen:function(){navigator.mediaDevices.getDisplayMedia().then(function(t){document.querySelector("video").srcObject=t,Object(m.r)(E.assignedTo,t,e.state.stream,!0)})},onEndCallFunctionality:function(){e.state.stream&&e.state.stream.getTracks().forEach(function(e){e.stop()});e.setState({showOutGoing:!1,hideIncomingCall:!1,stream:null}),Object(m.j)(),Object(m.w)(),Object(m.h)(N.contact,E.assignedTo);var t=document.getElementById("endCallReceiving");t&&t.click(),window.location.reload()}},e.state.callAccepted&&s.createElement(O.a,{myVideo:e.state.stream,incomingStream:e.state.incomingStream})),s.createElement("div",{className:"container-fluid "},!g&&!f&&!d&&s.createElement("div",{className:"content"},s.createElement("div",{className:"chatHead"},s.createElement("div",{className:"col-md-12"},s.createElement("div",{className:"form-group"},s.createElement("label",{className:"heading"})))),s.createElement("div",{id:"chatMessagesContainer",className:" padding-10 chatBody"},s.createElement("div",{className:"col-md-12"},s.createElement("div",{className:"card padding-10 scroll",id:"messageBody",style:{height:"500px",overflowX:"hidden",overflowY:"scroll",margin:"0px"}},s.createElement("div",{className:"container-fluid"},s.createElement("div",{className:"row"},s.createElement("div",{className:"col-md-12 col-xs-12 padding-10",style:{margin:"0px"}},0==n.length&&s.createElement("div",null," No messages found in this conversation. "),s.createElement("div",{className:"text-center"},s.createElement("button",{type:"button",className:"btn btn-primary btn-fill",onClick:function(){e.getMoreMessages()}}," ",s.createElement("i",{className:"fa fa-comment"}),"\xa0 Show More Messages ")),n&&n.map(function(t,n){if(t&&t.from){var a="";if(""!=t.attachmentImage){var i=t.attachmentImage,c=T.GetSignedURL(o.a.DOCUMENT(),i);i?(i.toLowerCase().indexOf(".mp4")>0&&(a="assets/img/video-file-icon.png"),i.toLowerCase().indexOf(".pdf")>0&&(a="assets/img/pdf-file-icon.png"),(i.toLowerCase().indexOf(".xls")>0||i.toLowerCase().indexOf(".csv")>0)&&(a="assets/img/excel-file-icon.png"),(i.toLowerCase().indexOf(".docx")>0||i.toLowerCase().indexOf(".txt")>0)&&(a="assets/img/doc-file-icon.png"),(i.toLowerCase().indexOf(".png")>0||i.toLowerCase().indexOf(".jpeg")>0||i.toLowerCase().indexOf(".jpg")>0||i.toLowerCase().indexOf(".tiff")>0)&&(a=c)):a=c}return s.createElement("div",{key:n,className:"padding-10 chat-message "+(t.from==N.contact?"inbound-message":"outbound-message")},""==a?s.createElement("div",{className:"message-text padding-5",style:{overflowWrap:"break-word"}},t.messageText):s.createElement("div",{className:"text-center"},s.createElement("p",null," ",t.messageText," "),s.createElement("img",{src:a,style:{height:65,cursor:"pointer"},onClick:function(){e.setState({isOpen:!0,documentName:t.attachmentImage})}})),s.createElement("div",{className:"sender-name"},s.createElement("label",null,s.createElement("b",null,t.fromName))),s.createElement("div",{className:"timestamp"},s.createElement("b",null,t.createdAt.ToEasternDateTime())))}}))))),s.createElement("footer",{className:"col-md-12 no-padding"},s.createElement("div",{className:"card",style:{margin:"0px"}},s.createElement("div",{className:"container-fluid"},s.createElement("div",{className:"row"},s.createElement("div",{className:"col-md-12 no-padding"},s.createElement("div",{className:"",style:{display:"inline-flex",padding:"0px",width:"100%"}},s.createElement("textarea",{className:"form-control",placeholder:"Type your message here...",name:"chatBox",value:a,style:{height:"97px",resize:"none"},onChange:function(t){return e.handleChatInput(t.target.value)},onKeyPress:function(t){return e.handleChatInputKeys(t)}}),s.createElement("button",{title:"Video Call",type:"button",className:"btn btn-primary btn-fill chatButton",onClick:function(){e.setState({showOutGoing:!0},function(){e.initiatingCall()})}},s.createElement("i",{className:"fa fa-video-camera"}),"\xa0"),s.createElement("button",{title:"Upload File","data-toggle":"modal","data-target":"#filesUploadDailogeBox",type:"button",className:"btn btn-primary btn-fill chatButton",onClick:function(){var t={docOntology:"",entityOntology:e.props.entityTitle?[{label:e.props.entityTitle,value:e.props.entityTitle}]:[],entityType:"Chat",documentType:"Media",documentSubtype:"",rdfsLabel:"",s3FileName:"",entryTimeStamp:"",enteredBy:"",enteredByName:"",linkToDocument:"",building:e.props.buildingName,buildingName:""};e.setState({documentObj:t,files:[]})}},s.createElement("i",{className:"fa fa-paperclip"}),"\xa0"),s.createElement("button",{disabled:""==e.state.chatText.trim(),type:"button",className:"btn pull-right btn-primary btn-fill chatButton",onClick:function(){e.sendMessage()}},s.createElement("i",{className:"fa fa-comment"}),"\xa0 Send ")),s.createElement("div",{className:"row"},s.createElement("div",{className:""},s.createElement(h.a,{id:"filesUploadDailogeBox",heading:"File Upload",saveButtonText:"Upload",isEditForm:!1,cancelButtonId:"closeAttachmentDialogue",onSaveButtonClick:function(){e.saveImage()},disableSaveButton:!i.rdfsLabel||0==c.length},s.createElement("div",{className:"card no-margin"},s.createElement("div",{className:"container-fluid dataCard"},s.createElement("div",{className:"content"},s.createElement("div",{className:"row padding-10"},s.createElement("div",{className:"col-md-12"},s.createElement("div",{className:"col-md-3 headingText padding-10",style:{textAlign:"center"}},"Title:"),s.createElement("div",{className:"col-md-9"},s.createElement("input",{id:"fileTitle",onChange:function(t){e.handleTitleChange(t.target.value)},type:"text",name:"fileTitle",value:i.rdfsLabel,className:"form-control"})))),s.createElement("div",{className:"row padding-10"},s.createElement("div",{className:"col-md-12"},s.createElement("div",{className:"col-md-3 headingText padding-10 center",style:{marginTop:"10%"}},"File Upload:"),s.createElement("div",{className:"col-md-9",onClick:function(){i.rdfsLabel?document.getElementById("fileTitle").style.boxShadow="0px 0px 15px gainsboro":document.getElementById("fileTitle").style.boxShadow="0px 0px 15px red"}},s.createElement(p.a,{disable:!i.rdfsLabel,single:!0,handleAttachedFile:e.handlefileAttached,files:c}))))))))))))),r&&s.createElement("div",null,s.createElement(v.a,{mainSrc:T.GetSignedURL(o.a.DOCUMENT(),e.state.documentName),onCloseRequest:function(){e.setState({isOpen:!1,documentName:""})},onMovePrevRequest:function(){},onMoveNextRequest:function(){}})))))))),s.createElement("button",{type:"button",id:"addNewMessage",className:"hidden",onClick:function(){e.addNewMessage()}},"."))})},t}(s.Component);t.default=C}});